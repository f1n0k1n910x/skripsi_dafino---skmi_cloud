// --- Translation Data (Global) ---
const translations = {
    // Sidebar
    'controlCenter': { 'id': 'Control Center', 'en': 'Control Center' },
    'myDrive': { 'id': 'Drive Saya', 'en': 'My Drive' },
    'priorityFile': { 'id': 'File Prioritas', 'en': 'Priority File' },
    'recycleBin': { 'id': 'Tempat Sampah', 'en': 'Recycle Bin' },
    'summary': { 'id': 'Ringkasan', 'en': 'Summary' },
    'members': { 'id': 'Anggota', 'en': 'Members' },
    'profile': { 'id': 'Profil', 'en': 'Profile' },
    'logout': { 'id': 'Keluar', 'en': 'Logout' },
    'storage': { 'id': 'Penyimpanan', 'en': 'Storage' },
    'storageFull': { 'id': 'Penyimpanan Penuh! Tidak dapat mengunggah lebih banyak file.', 'en': 'Storage Full! Cannot upload more files.' },
    'ofUsed': { 'id': 'dari', 'en': 'of' },
    'usedTextId': 'terpakai',
    'usedTextEn': 'used',

    // Main Content - Header
    'myDriveTitle': { 'id': 'Drive Saya', 'en': 'My Drive' },
    'searchFiles': { 'id': 'Cari file...', 'en': 'Search files...' },

    // Toolbar
    'uploadFile': { 'id': 'Unggah File', 'en': 'Upload File' },
    'createFolder': { 'id': 'Buat Folder', 'en': 'Create Folder' },
    'deleteSelected': { 'id': 'Hapus Terpilih', 'en': 'Delete Selected' },
    'archive': { 'id': 'Arsipkan', 'en': 'Archive' },
    'allFiles': { 'id': 'Semua File', 'en': 'All Files' },
    'documents': { 'id': 'Dokumen', 'en': 'Documents' },
    'images': { 'id': 'Gambar', 'en': 'Images' },
    'music': { 'id': 'Musik', 'en': 'Music' },
    'videos': { 'id': 'Video', 'en': 'Videos' },
    'archives': { 'id': 'Arsip', 'en': 'Archives' },
    'cadFiles': { 'id': 'File CAD', 'en': 'CAD Files' },
    'codeFiles': { 'id': 'File Kode', 'en': 'Code Files' },
    'installationFiles': { 'id': 'File Instalasi', 'en': 'Installation Files' },
    'p2pFiles': { 'id': 'File Peer-to-Peer', 'en': 'Peer-to-Peer Files' },
    'sizeLargeToSmall': { 'id': 'Ukuran (Besar ke Kecil)', 'en': 'Size (Large to Small)' },
    'sizeSmallToLarge': { 'id': 'Ukuran (Kecil ke Besar)', 'en': 'Size (Small to Large)' },
    'defaultAlphabetical': { 'id': 'Default (Abjad)', 'en': 'Default (Alphabetical)' },

    // Breadcrumbs
    'root': { 'id': 'Root', 'en': 'Root' },
    'searchResultsFor': { 'id': 'Hasil pencarian untuk', 'en': 'Search results for' },

    // File List/Grid
    'noFilesOrFoldersFoundSearch': { 'id': 'Tidak ada file atau folder yang ditemukan cocok dengan', 'en': 'No files or folders found matching' },
    'noFilesOrFoldersFoundDirectory': { 'id': 'Tidak ada file atau folder yang ditemukan di direktori ini.', 'en': 'No files or folders found in this directory.' },
    'name': { 'id': 'Nama', 'en': 'Name' },
    'type': { 'id': 'Tipe', 'en': 'Type' },
    'size': { 'id': 'Ukuran', 'en': 'Size' },
    'lastModified': { 'id': 'Terakhir Dimodifikasi', 'en': 'Last Modified' },
    'actions': { 'id': 'Tindakan', 'en': 'Actions' },
    'folder': { 'id': 'Folder', 'en': 'Folder' },
    'cadFile': { 'id': 'File CAD', 'en': 'CAD File' },
    'file': { 'id': 'File', 'en': 'File' },

    // Modals
    'selectFiles': { 'id': 'Pilih File(s):', 'en': 'Select File(s):' },
    'upload': { 'id': 'Unggah', 'en': 'Upload' },
    'createNewFolder': { 'id': 'Buat Folder Baru', 'en': 'Create New Folder' },
    'folderName': { 'id': 'Nama Folder:', 'en': 'Folder Name:' },
    'rename': { 'id': 'Ganti Nama', 'en': 'Rename' },
    'newName': { 'id': 'Nama Baru:', 'en': 'New Name:' },
    'renameBtn': { 'id': 'Ganti Nama', 'en': 'Rename' },
    'fileUpload': { 'id': 'Unggah File', 'en': 'File Upload' },
    'shareLink': { 'id': 'Bagikan Tautan', 'en': 'Share Link' },
    'shareLinkDescription': { 'id': 'Berikut adalah tautan yang dapat dibagikan untuk file Anda:', 'en': 'Here is the shareable link for your file:' },
    'copy': { 'id': 'Salin', 'en': 'Copy' },
    'anyoneWithLink': { 'id': 'Siapa pun dengan tautan ini dapat melihat file.', 'en': 'Anyone with this link can view the file.' },

    // Context Menu
    'download': { 'id': 'Unduh', 'en': 'Download' },
    'extractZip': { 'id': 'Ekstrak ZIP', 'en': 'Extract ZIP' },
    'pinToPriority': { 'id': 'Sematkan ke Prioritas', 'en': 'Pin to Priority' },
    'delete': { 'id': 'Hapus', 'en': 'Delete' },

    // Notifications
    'pleaseSelectToDelete': { 'id': 'Pilih setidaknya satu file atau folder untuk dihapus!', 'en': 'Please select at least one file or folder to delete!' },
    'noPermissionRestrictedDelete': { 'id': 'Anda tidak memiliki izin untuk menghapus jenis file terbatas.', 'en': 'You do not have permission to delete restricted file types.' },
    'confirmDelete': { 'id': 'Anda yakin ingin menghapus item yang dipilih? Ini akan menghapus semua file dan subfolder di dalamnya!', 'en': 'Are you sure you want to delete the selected items? This will delete all files and subfolders within them!' },
    'itemsDeletedSuccess': { 'id': 'Item berhasil dihapus!', 'en': 'Items deleted successfully!' },
    'failedToDelete': { 'id': 'Gagal menghapus item:', 'en': 'Failed to delete items:' },
    'errorDeleting': { 'id': 'Terjadi kesalahan saat menghapus item.', 'en': 'An error occurred while deleting items.' },
    'pleaseSelectToArchive': { 'id': 'Pilih setidaknya satu file atau folder untuk diarsipkan!', 'en': 'Please select at least one file or folder to archive!' },
    'noPermissionRestrictedArchive': { 'id': 'Anda tidak memiliki izin untuk mengarsipkan jenis file terbatas.', 'en': 'You do not have permission to archive restricted file types.' },
    'confirmArchive': { 'id': 'Anda yakin ingin mengarsipkan item yang dipilih ke format', 'en': 'Are you sure you want to archive the selected items to' },
    'startingArchive': { 'id': 'Memulai proses pengarsipan...', 'en': 'Starting archive process...' },
    'failedToArchive': { 'id': 'Gagal mengarsipkan:', 'en': 'Failed to archive:' },
    'errorArchiving': { 'id': 'Terjadi kesalahan saat mengarsipkan item.', 'en': 'An error occurred while archiving items.' },
    'noPermissionRestrictedRename': { 'id': 'Anda tidak memiliki izin untuk mengganti nama jenis file terbatas.', 'en': 'You do not have permission to rename restricted file types.' },
    'noPermissionRestrictedDownload': { 'id': 'Anda tidak memiliki izin untuk mengunduh jenis file terbatas.', 'en': 'You do not have permission to download restricted file types.' },
    'confirmExtract': { 'id': 'Anda yakin ingin mengekstrak file ZIP ini? Ini akan diekstrak ke folder baru bernama file ZIP di direktori saat ini.', 'en': 'Are you sure you want to extract this ZIP file? It will be extracted to a new folder named after the ZIP file in the current directory.' },
    'extractingZip': { 'id': 'Mengekstrak file ZIP...', 'en': 'Extracting ZIP file...' },
    'extractionFailed': { 'id': 'Ekstraksi gagal:', 'en': 'Extraction failed:' },
    'errorExtracting': { 'id': 'Terjadi kesalahan selama ekstraksi.', 'en': 'An error occurred during extraction.' },
    'noPermissionRestrictedPin': { 'id': 'Anda tidak memiliki izin untuk menyematkan jenis file terbatas ke prioritas.', 'en': 'You do not have permission to pin restricted file types to priority.' },
    'failedToToggleStar': { 'id': 'Gagal menyematkan:', 'en': 'Failed to toggle star:' },
    'errorTogglingStar': { 'id': 'Terjadi kesalahan saat menyematkan.', 'en': 'An error occurred while toggling star.' },
    'folderCreatedSuccess': { 'id': 'Folder berhasil dibuat!', 'en': 'Folder created successfully!' },
    'failedToCreateFolder': { 'id': 'Gagal membuat folder:', 'en': 'Failed to create folder:' },
    'errorCreatingFolder': { 'id': 'Terjadi kesalahan saat membuat folder.', 'en': 'An error occurred while creating the folder.' },
    'itemRenamedSuccess': { 'id': 'Item berhasil diganti namanya!', 'en': 'Item renamed successfully!' },
    'failedToRename': { 'id': 'Gagal mengganti nama:', 'en': 'Failed to rename:' },
    'errorRenaming': { 'id': 'Terjadi kesalahan saat mengganti nama.', 'en': 'An error occurred while renaming.' },
    'noFilesToUpload': { 'id': 'Pilih file untuk diunggah terlebih dahulu.', 'en': 'Please select files to upload first.' },
    'fileRestrictedUpload': { 'id': 'File ini adalah jenis terbatas dan tidak dapat diunggah.', 'en': 'This file is a restricted type and cannot be uploaded.' },
    'noFilesEligible': { 'id': 'Tidak ada file yang memenuhi syarat untuk diunggah.', 'en': 'No files eligible for upload.' },
    'fileUploadedSuccess': { 'id': 'File berhasil diunggah.', 'en': 'File uploaded successfully.' },
    'uploadCancelled': { 'id': 'Unggahan dibatalkan.', 'en': 'Upload cancelled.' },
    'failedToUpload': { 'id': 'Gagal mengunggah:', 'en': 'Failed to upload:' },
    'uploadManuallyCancelled': { 'id': 'Unggahan dibatalkan secara manual.', 'en': 'Upload manually cancelled.' },
    'generatingShareLink': { 'id': 'Membuat tautan berbagi...', 'en': 'Generating share link...' },
    'onlyFilesCanBeShared': { 'id': 'Hanya file yang dapat dibagikan melalui tautan singkat.', 'en': 'Only files can be shared via shortlink.' },
    'noPermissionRestrictedShare': { 'id': 'Anda tidak memiliki izin untuk membagikan jenis file terbatas.', 'en': 'You do not have permission to share restricted file types.' },
    'shareLinkGenerated': { 'id': 'Tautan berbagi berhasil dibuat!', 'en': 'Share link generated!' },
    'failedToGenerateShareLink': { 'id': 'Gagal membuat tautan berbagi:', 'en': 'Failed to generate share link:' },
    'errorGeneratingShareLink': { 'id': 'Terjadi kesalahan saat membuat tautan berbagi.', 'en': 'An error occurred while generating the share link.' },
    'linkCopied': { 'id': 'Tautan disalin ke clipboard!', 'en': 'Link copied to clipboard!' },
    'noPermissionRestrictedOpen': { 'id': 'Anda tidak memiliki izin untuk membuka jenis file terbatas.', 'en': 'You do not have permission to open restricted file types.' },
    'failedToUpdateFileList': { 'id': 'Gagal memperbarui daftar file. Harap segarkan halaman.', 'en': 'Failed to update file list. Please refresh the page.' },
    'storageFullCannotUpload': { 'id': 'Penyimpanan penuh! Tidak dapat mengunggah lebih banyak file.', 'en': 'Storage full! Cannot upload more files.' },
    'storageFullCannotCreateFolder': { 'id': 'Penyimpanan penuh! Tidak dapat membuat folder baru.', 'en': 'Storage full! Cannot create new folders.' },
};

let currentLanguage = localStorage.getItem('lang') || 'id'; // Default to Indonesian

// Access PHP variables passed from index.php
const currentUserRole = phpVars.currentUserRole;
const restrictedFileTypes = phpVars.restrictedFileTypes;
let currentFolderId = phpVars.currentFolderId;
let currentSearchQuery = phpVars.searchQuery;
let currentSizeFilter = phpVars.sizeFilter;
let currentFileTypeFilter = phpVars.fileTypeFilter;
const usedStorageBytes = phpVars.usedStorageBytes;
const totalStorageBytes = phpVars.totalStorageBytes;
const isStorageFull = phpVars.isStorageFull;

// File extension categories (re-defined in JS for client-side logic)
const docExt = phpVars.docExt;
const musicExt = phpVars.musicExt;
const videoExt = phpVars.videoExt;
const codeExt = phpVars.codeExt;
const archiveExt = phpVars.archiveExt;
const instExt = phpVars.instExt;
const ptpExt = phpVars.ptpExt;
const imageExt = phpVars.imageExt;
const cadExt = phpVars.cadExt;


function formatBytes(bytes, precision = 2) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(precision)) + ' ' + sizes[i];
}

function applyTranslation(lang) {
    document.querySelectorAll('[data-lang-key]').forEach(element => {
        const key = element.getAttribute('data-lang-key');
        if (translations[key] && translations[key][lang]) {
            element.textContent = translations[key][lang];
        }
    });

    document.querySelectorAll('[data-lang-placeholder]').forEach(element => {
        const key = element.getAttribute('data-lang-placeholder');
        if (translations[key] && translations[key][lang]) {
            element.placeholder = translations[key][lang];
        }
    });

    // Special handling for "of X used" text in storage info
    const storageTextElement = document.getElementById('storageText');
    if (storageTextElement) {
        storageTextElement.textContent = `${formatBytes(usedStorageBytes)} ${translations['ofUsed'][lang]} ${formatBytes(totalStorageBytes)} ${translations['usedText' + (lang === 'id' ? 'Id' : 'En')]}`;
    }

    // Special handling for search results text
    const searchResultsSpan = document.querySelector('.breadcrumbs span[data-lang-key="searchResultsFor"]');
    if (searchResultsSpan) {
        const originalQuery = phpVars.searchQuery; // Use phpVars.searchQuery
        searchResultsSpan.textContent = `${translations['searchResultsFor'][lang]} "${originalQuery}"`;
    }

    // Special handling for folder/file type labels in grid view
    document.querySelectorAll('.grid-thumbnail .file-type-label').forEach(element => {
        const key = element.getAttribute('data-lang-key');
        if (key && translations[key] && translations[key][lang]) {
            element.textContent = translations[key][lang];
        }
    });

    // Special handling for file type labels like "CAD File" or "ZIP File"
    document.querySelectorAll('.grid-thumbnail span').forEach(element => {
        if (element.textContent.includes('CAD File')) {
            element.textContent = translations['cadFile'][lang];
        } else if (element.textContent.includes('File')) {
            const fileExt = element.textContent.split(' ')[0];
            element.textContent = `${fileExt} ${translations['file'][lang]}`;
        }
    });

    // Update placeholder for rename modal
    const renameItemTypeSpan = document.getElementById('renameItemType');
    if (renameItemTypeSpan && renameItemTypeSpan.textContent) {
        const originalType = renameItemTypeSpan.textContent;
        if (originalType === 'Folder' || originalType === 'File') {
            renameItemTypeSpan.textContent = translations[originalType.toLowerCase()][lang];
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const uploadFileBtn = document.getElementById('uploadFileBtn');
    const createFolderBtn = document.getElementById('createFolderBtn');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    
    // Dropdown elements (main toolbar)
    const archiveDropdownContainer = document.querySelector('.toolbar .dropdown-container.archive-dropdown-container');
    const archiveSelectedBtn = document.getElementById('archiveSelectedBtn');
    const archiveDropdownContent = document.querySelector('.toolbar .archive-dropdown-content');

    const sizeFilterDropdownContainer = document.querySelector('.toolbar .dropdown-container.size-filter-dropdown-container');
    const sizeFilterBtn = document.getElementById('sizeFilterBtn');
    const sizeFilterDropdownContent = document.querySelector('.toolbar .size-filter-dropdown-content');

    const fileTypeFilterDropdownContainer = document.querySelector('.toolbar .dropdown-container.file-type-filter-dropdown-container');
    const fileTypeFilterBtn = document.getElementById('fileTypeFilterBtn');
    const fileTypeFilterDropdownContent = document.querySelector('.toolbar .file-type-filter-dropdown-content');

    // Dropdown elements (header)
    const archiveSelectedBtnHeader = document.getElementById('archiveSelectedBtnHeader');
    const fileTypeFilterBtnHeader = document.getElementById('fileTypeFilterBtnHeader');
    const sizeFilterBtnHeader = document.getElementById('sizeFilterBtnHeader');
    const listViewBtnHeader = document.getElementById('listViewBtnHeader');
    const gridViewBtnHeader = document.getElementById('gridViewBtnHeader');


    const uploadFileModal = document.getElementById('uploadFileModal');
    const createFolderModal = document.getElementById('createFolderModal');
    const renameModal = document.getElementById('renameModal');
    const uploadPreviewModal = document.getElementById('uploadPreviewModal');
    const uploadPreviewList = document.getElementById('uploadPreviewList');
    const fileToUploadInput = document.getElementById('fileToUpload');
    const startUploadBtn = document.getElementById('startUploadBtn');
    const uploadPreviewBackBtn = document.getElementById('uploadPreviewBackBtn');
    const closeUploadPreviewBtn = document.getElementById('closeUploadPreviewBtn');

    const closeButtons = document.querySelectorAll('.close-button');

    const listViewBtn = document.getElementById('listViewBtn');
    const gridViewBtn = document.getElementById('gridViewBtn');
    const fileListView = document.getElementById('fileListView');
    const fileGridView = document.getElementById('fileGridView');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const searchInput = document.getElementById('searchInput'); // Desktop search
    const searchInputMobile = document.getElementById('searchInputMobile'); // Mobile search
    const customNotification = document.getElementById('customNotification');

    // New elements for Share Link
    const shareLinkModal = document.getElementById('shareLinkModal');
    const shortLinkOutput = document.getElementById('shortLinkOutput');
    const copyShortLinkBtn = document.getElementById('copyShortLinkBtn');

    // Context Menu elements
    const contextMenu = document.getElementById('context-menu');
    const contextRename = document.querySelector('#context-menu [data-action="rename"]');
    const contextDownload = document.querySelector('#context-menu [data-action="download"]');
    const contextShare = document.querySelector('#context-menu [data-action="share"]');
    const contextExtract = document.querySelector('#context-menu [data-action="extract"]');
    const contextToggleStar = document.querySelector('#context-menu [data-action="toggle-star"]');
    const contextDelete = document.querySelector('#context-menu [data-action="delete"]');

    // Mobile sidebar elements
    const sidebar = document.querySelector('.sidebar');
    const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
    const mobileOverlay = document.getElementById('mobileOverlay');
    const mainContent = document.getElementById('mainContent');

    let activeUploads = new Map();

    // Variables for long press
    let lpTimer = null;
    let lpStart = null;
    const longPressDuration = 600; // milliseconds
    const longPressMoveThreshold = 10; // pixels

    /*** Util helpers ****/
    function debounce(fn, ms=150){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    function closestFileItem(el){ return el && el.closest('.file-item'); }

    /*** Device detection & body class toggling ***/
    function setDeviceClass() {
        const ua = navigator.userAgent || '';
        const w = window.innerWidth;
        document.body.classList.remove('mobile', 'tablet-portrait', 'tablet-landscape', 'desktop'); // Clear all
        if (w <= 767) {
            document.body.classList.add('mobile');
        } else if (w >= 768 && w <= 1024) {
            if (window.matchMedia("(orientation: portrait)").matches) {
                document.body.classList.add('tablet-portrait');
            } else {
                document.body.classList.add('tablet-landscape');
            }
        } else {
            document.body.classList.add('desktop');
        }
    }
    window.addEventListener('resize', debounce(setDeviceClass, 150));
    window.addEventListener('orientationchange', setDeviceClass); // Listen for orientation changes
    setDeviceClass(); // init

    // Function to get file icon class based on extension
    function getFileIconClass(fileName) {
        const extension = fileName.split('.').pop().toLowerCase();
        switch (extension) {
            case 'pdf': return 'fa-file-pdf';
            case 'doc':
            case 'docx': return 'fa-file-word';
            case 'xls':
            case 'xlsx': return 'fa-file-excel';
            case 'ppt':
            case 'pptx': return 'fa-file-powerpoint';
            case 'jpg':
            case 'jpeg':
            case 'png':
            case 'gif':
            case 'bmp':
            case 'webp': return 'fa-file-image';
            case 'zip':
            case 'rar':
            case '7z': return 'fa-file-archive';
            case 'txt':
            case 'log':
            case 'md': return 'fa-file-alt';
            case 'exe':
            case 'apk': return 'fa-box';
            case 'mp3':
            case 'wav':
            case 'flac': return 'fa-file-audio';
            case 'mp4':
            case 'avi':
            case 'mkv': return 'fa-file-video';
            case 'html':
            case 'htm': return 'fa-file-code';
            case 'css': return 'fa-file-code';
            case 'js': return 'fa-file-code';
            case 'php': return 'fa-file-code';
            case 'py': return 'fa-file-code';
            case 'json': return 'fa-file-code';
            case 'sql': return 'fa-database';
            case 'svg': return 'fa-file-image';
            case 'sh':
            case 'bat': return 'fa-file-code';
            case 'ini':
            case 'yml':
            case 'yaml': return 'fa-file-code';
            case 'java': return 'fa-java';
            case 'c':
            case 'cpp': return 'fa-file-code';
            case 'dwg':
            case 'dxf':
            case 'dgn':
            case 'iges':
            case 'igs':
            case 'step':
            case 'stp':
            case 'stl':
            case '3ds':
            case 'obj':
            case 'sldprt':
            case 'sldasm':
            case 'ipt':
            case 'iam':
            case 'catpart':
            case 'catproduct':
            case 'prt':
            case 'asm':
            case 'fcstd':
            case 'skp':
            case 'x_t':
            case 'x_b': return 'fa-cube';
            default: return 'fa-file';
        }
    }

    // Function to get file color class based on extension
    function getFileColorClass(fileName) {
        const extension = fileName.split('.').pop().toLowerCase();
        const colorClasses = {
            'pdf': 'file-color-pdf', 'doc': 'file-color-doc', 'docx': 'file-color-doc',
            'xls': 'file-color-xls', 'xlsx': 'file-color-xls', 'ppt': 'file-color-ppt',
            'pptx': 'file-color-ppt', 'txt': 'file-color-txt', 'rtf': 'file-color-txt',
            'md': 'file-color-txt', 'csv': 'file-color-csv', 'odt': 'file-color-doc',
            'odp': 'file-color-ppt', 'log': 'file-color-txt', 'tex': 'file-color-txt',
            'jpg': 'file-color-image', 'jpeg': 'file-color-image', 'png': 'file-color-image',
            'gif': 'file-color-image', 'bmp': 'file-color-image', 'webp': 'file-color-image',
            'svg': 'file-color-image', 'tiff': 'file-color-image',
            'mp3': 'file-color-audio', 'wav': 'file-color-audio', 'ogg': 'file-color-audio',
            'flac': 'file-color-audio', 'aac': 'file-color-audio', 'm4a': 'file-color-audio',
            'alac': 'file-color-audio', 'wma': 'file-color-audio', 'opus': 'file-color-audio',
            'amr': 'file-color-audio', 'mid': 'file-color-audio',
            'mp4': 'file-color-video', 'avi': 'file-color-video', 'mov': 'file-color-video',
            'wmv': 'file-color-video', 'flv': 'file-color-video', 'webm': 'file-color-video',
            '3gp': 'file-color-video', 'm4v': 'file-color-video', 'mpg': 'file-color-video',
            'mpeg': 'file-color-video', 'ts': 'file-color-video', 'ogv': 'file-color-video',
            'zip': 'file-color-archive', 'rar': 'file-color-archive', '7z': 'file-color-archive',
            'tar': 'file-color-archive', 'gz': 'file-color-archive', 'bz2': 'file-color-archive',
            'xz': 'file-color-archive', 'iso': 'file-color-archive', 'cab': 'file-color-archive',
            'arj': 'file-color-archive',
            'html': 'file-color-code', 'htm': 'file-color-code', 'css': 'file-color-code',
            'js': 'file-color-code', 'php': 'file-color-code', 'py': 'file-color-code',
            'java': 'file-color-code', 'json': 'file-color-code', 'xml': 'file-color-code',
            'ts': 'file-color-code', 'tsx': 'file-color-code', 'jsx': 'file-color-code',
            'vue': 'file-color-code', 'cpp': 'file-color-code', 'c': 'file-color-code',
            'cs': 'file-color-code', 'rb': 'file-color-code', 'go': 'file-color-code',
            'swift': 'file-color-code', 'sql': 'file-color-code', 'sh': 'file-color-code',
            'bat': 'file-color-code', 'ini': 'file-color-code', 'yml': 'file-color-code',
            'yaml': 'file-color-code', 'pl': 'file-color-code', 'r': 'file-color-code',
            'exe': 'file-color-exe', 'msi': 'file-color-exe', 'apk': 'file-color-exe',
            'ipa': 'file-color-exe', 'jar': 'file-color-exe', 'appimage': 'file-color-exe',
            'dmg': 'file-color-exe', 'bin': 'file-color-exe',
            'torrent': 'file-color-default', 'nzb': 'file-color-default', 'ed2k': 'file-color-default',
            'part': 'file-color-default', '!ut': 'file-color-default',
            'dwg': 'file-color-cad', 'dxf': 'file-color-cad', 'dgn': 'file-color-cad',
            'iges': 'file-color-cad', 'igs': 'file-color-cad', 'step': 'file-color-cad',
            'stp': 'file-color-cad', 'stl': 'file-color-cad', '3ds': 'file-color-cad',
            'obj': 'file-color-cad', 'sldprt': 'file-color-cad', 'sldasm': 'file-color-cad',
            'ipt': 'file-color-cad', 'iam': 'file-color-cad', 'catpart': 'file-color-cad',
            'catproduct': 'file-color-cad', 'prt': 'file-color-cad', 'asm': 'file-color-cad',
            'fcstd': 'file-color-cad', 'skp': 'file-color-cad', 'x_t': 'file-color-cad',
            'x_b': 'file-color-cad',
            'default': 'file-color-default'
        };
        return colorClasses[extension] || colorClasses['default'];
    }

    // Function to show custom notification
    function showNotification(messageKey, type, dynamicContent = '') {
        let message = translations[messageKey] ? translations[messageKey][currentLanguage] : messageKey;
        if (dynamicContent) {
            message += ` ${dynamicContent}`;
        }
        customNotification.innerHTML = message;
        customNotification.className = 'notification show ' + type;
        setTimeout(() => {
            customNotification.classList.remove('show');
        }, 3000);
    }

    // --- Modal Open/Close Logic ---
    function openModal(modalElement) {
        modalElement.classList.add('show');
    }

    function closeModal(modalElement) {
        modalElement.classList.remove('show');
        // Reset form if it's a form modal
        const form = modalElement.querySelector('form');
        if (form) {
            form.reset();
        }
    }

    uploadFileBtn.addEventListener('click', () => {
        // Check if storage is full before opening modal
        if (isStorageFull) { // Use isStorageFull from phpVars
            showNotification('storageFullCannotUpload', 'error');
            return;
        }
        openModal(uploadFileModal);
        fileToUploadInput.value = '';
        uploadPreviewList.innerHTML = '';
        startUploadBtn.style.display = 'none';
    });

    createFolderBtn.addEventListener('click', () => {
        // Check if storage is full before opening modal
        if (isStorageFull) { // Use isStorageFull from phpVars
            showNotification('storageFullCannotCreateFolder', 'error');
            return;
        }
        openModal(createFolderModal);
    });

    closeButtons.forEach(button => {
        button.addEventListener('click', () => {
            closeModal(uploadFileModal);
            closeModal(createFolderModal);
            closeModal(renameModal);
            closeModal(uploadPreviewModal);
            closeModal(shareLinkModal);
            activeUploads.forEach(controller => controller.abort());
            activeUploads.clear();
        });
    });

    uploadPreviewBackBtn.addEventListener('click', () => {
        closeModal(uploadPreviewModal);
        openModal(uploadFileModal);
        activeUploads.forEach(controller => controller.abort());
        activeUploads.clear();
    });

    window.addEventListener('click', (event) => {
        if (event.target == uploadFileModal) {
            closeModal(uploadFileModal);
        }
        if (event.target == createFolderModal) {
            closeModal(createFolderModal);
        }
        if (event.target == renameModal) {
            closeModal(renameModal);
        }
        if (event.target == uploadPreviewModal) {
            closeModal(uploadPreviewModal);
            activeUploads.forEach(controller => controller.abort());
            activeUploads.clear();
        }
        if (event.target == shareLinkModal) {
            closeModal(shareLinkModal);
        }
        // Close all dropdowns if clicked outside
        // Main toolbar dropdowns
        if (archiveDropdownContainer && !archiveDropdownContainer.contains(event.target)) {
            archiveDropdownContainer.classList.remove('show');
        }
        if (sizeFilterDropdownContainer && !sizeFilterDropdownContainer.contains(event.target)) {
            sizeFilterDropdownContainer.classList.remove('show');
        }
        if (fileTypeFilterDropdownContainer && !fileTypeFilterDropdownContainer.contains(event.target)) {
            fileTypeFilterDropdownContainer.classList.remove('show');
        }

        // Header toolbar dropdowns (now toolbar-filter-buttons)
        const headerArchiveDropdownContainer = document.querySelector('.toolbar-filter-buttons .dropdown-container.archive-dropdown-container');
        const headerFileTypeDropdownContainer = document.querySelector('.toolbar-filter-buttons .dropdown-container.file-type-filter-dropdown-container');
        const headerSizeFilterDropdownContainer = document.querySelector('.toolbar-filter-buttons .dropdown-container.size-filter-dropdown-container');
        // No need to handle view-toggle as it's not a dropdown that opens/closes

        if (headerArchiveDropdownContainer && !headerArchiveDropdownContainer.contains(event.target)) {
            headerArchiveDropdownContainer.classList.remove('show');
        }
        if (headerFileTypeDropdownContainer && !headerFileTypeDropdownContainer.contains(event.target)) {
            headerFileTypeDropdownContainer.classList.remove('show');
        }
        if (headerSizeFilterDropdownContainer && !headerSizeFilterDropdownContainer.contains(event.target)) {
            headerSizeFilterDropdownContainer.classList.remove('show');
        }

        // Close context menu if clicked outside
        if (!contextMenu.contains(event.target)) {
            hideContextMenu();
        }
        // Close mobile sidebar if overlay is clicked
        if (event.target == mobileOverlay && sidebar.classList.contains('show-mobile-sidebar')) {
            sidebar.classList.remove('show-mobile-sidebar');
            mobileOverlay.classList.remove('show');
        }
    });

    // --- View Toggle Logic ---
    function setupViewToggle(listViewBtnElement, gridViewBtnElement) {
        listViewBtnElement.addEventListener('click', () => {
            listViewBtnElement.classList.add('active');
            gridViewBtnElement.classList.remove('active');
            fileListView.classList.remove('hidden');
            fileGridView.classList.add('hidden');
            localStorage.setItem('fileView', 'list');
        });

        gridViewBtnElement.addEventListener('click', () => {
            gridViewBtnElement.classList.add('active');
            listViewBtnElement.classList.remove('active');
            fileGridView.classList.remove('hidden');
            fileListView.classList.add('hidden');
            localStorage.setItem('fileView', 'grid');
        });
    }

    setupViewToggle(listViewBtn, gridViewBtn); // For main toolbar
    setupViewToggle(listViewBtnHeader, gridViewBtnHeader); // For header button

    const savedView = localStorage.getItem('fileView');
    if (savedView === 'grid') {
        gridViewBtn.click(); // Simulate click to activate
        gridViewBtnHeader.click(); // Simulate click for header button
    } else {
        listViewBtn.click(); // Simulate click to activate
        listViewBtnHeader.click(); // Simulate click for header button
    }

    // --- Select All Checkbox Logic ---
    function updateSelectAllCheckboxListener() {
        const fileCheckboxes = document.querySelectorAll('.file-checkbox');
        selectAllCheckbox.checked = false;
        selectAllCheckbox.removeEventListener('change', handleSelectAllChange);
        selectAllCheckbox.addEventListener('change', handleSelectAllChange);

        fileCheckboxes.forEach(checkbox => {
            checkbox.removeEventListener('change', handleIndividualCheckboxChange);
            checkbox.addEventListener('change', handleIndividualCheckboxChange);
        });
    }

    function handleSelectAllChange() {
        const fileCheckboxes = document.querySelectorAll('.file-checkbox');
        fileCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    }

    function handleIndividualCheckboxChange() {
        const fileCheckboxes = document.querySelectorAll('.file-checkbox');
        if (!this.checked) {
            selectAllCheckbox.checked = false;
        } else {
            const allChecked = Array.from(fileCheckboxes).every(cb => cb.checked);
            selectAllCheckbox.checked = allChecked;
        }
    }

    updateSelectAllCheckboxListener();

    // --- Delete Selected Files/Folders ---
    deleteSelectedBtn.addEventListener('click', async () => {
        const checkboxes = document.querySelectorAll('.file-checkbox:checked');
        const selectedItems = Array.from(checkboxes).map(cb => {
            return { id: cb.dataset.id, type: cb.dataset.type };
        });

        if (selectedItems.length === 0) {
            showNotification('pleaseSelectToDelete', 'error');
            return;
        }

        const hasRestricted = selectedItems.some(item => {
            if (item.type === 'file') {
                const fileElement = document.querySelector(`.file-item[data-id="${CSS.escape(item.id)}"]`);
                const fileType = fileElement ? fileElement.dataset.fileType : '';
                return restrictedFileTypes.includes(fileType);
            }
            return false;
        });

        if (hasRestricted && currentUserRole !== 'admin' && currentUserRole !== 'moderator') {
            showNotification('noPermissionRestrictedDelete', 'error');
            return;
        }

        if (!confirm(translations['confirmDelete'][currentLanguage])) {
            return;
        }

        try {
            const response = await fetch('delete_selected.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ items: selectedItems })
            });
            const data = await response.json();
            if (data.success) {
                showNotification('itemsDeletedSuccess', 'success');
                updateFileListAndFolders();
            } else {
                showNotification('failedToDelete', 'error', data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('errorDeleting', 'error');
        }
    });

    // --- Archive Selected Files/Folders ---
    function setupArchiveDropdown(buttonId, dropdownContentSelector) {
        const button = document.getElementById(buttonId);
        const dropdownContent = document.querySelector(dropdownContentSelector);
        const dropdownContainer = button.closest('.dropdown-container');

        if (!button || !dropdownContent || !dropdownContainer) return;

        button.addEventListener('click', (event) => {
            event.stopPropagation();
            document.querySelectorAll('.dropdown-container.show').forEach(openDropdown => {
                if (openDropdown !== dropdownContainer) {
                    openDropdown.classList.remove('show');
                }
            });
            dropdownContainer.classList.toggle('show');
        });

        dropdownContent.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', async (event) => {
                event.preventDefault();
                dropdownContainer.classList.remove('show');

                const format = event.target.dataset.format;
                const checkboxes = document.querySelectorAll('.file-checkbox:checked');
                const selectedItems = Array.from(checkboxes).map(cb => {
                    return { id: cb.dataset.id, type: cb.dataset.type };
                });

                if (selectedItems.length === 0) {
                    showNotification('pleaseSelectToArchive', 'error');
                    return;
                }

                const hasRestricted = selectedItems.some(item => {
                    if (item.type === 'file') {
                        const fileElement = document.querySelector(`.file-item[data-id="${CSS.escape(item.id)}"]`);
                        const fileType = fileElement ? fileElement.dataset.fileType : '';
                        return restrictedFileTypes.includes(fileType);
                    }
                    return false;
                });

                if (hasRestricted && currentUserRole !== 'admin' && currentUserRole !== 'moderator') {
                    showNotification('noPermissionRestrictedArchive', 'error');
                    return;
                }

                if (!confirm(`${translations['confirmArchive'][currentLanguage]} ${format.toUpperCase()} format?`)) {
                    return;
                }

                showNotification('startingArchive', 'info');

                try {
                    const response = await fetch('compress.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            items: selectedItems,
                            format: format,
                            current_folder_id: currentFolderId
                        })
                    });
                    const data = await response.json();
                    if (data.success) {
                        showNotification(data.message, 'success');
                        updateFileListAndFolders();
                    } else {
                        showNotification('failedToArchive', 'error', data.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('errorArchiving', 'error');
                }
            });
        });
    }

    setupArchiveDropdown('archiveSelectedBtn', '.toolbar .archive-dropdown-content');
    setupArchiveDropdown('archiveSelectedBtnHeader', '.toolbar-filter-buttons .archive-dropdown-content');


    // --- File Type Filter ---
    function setupFileTypeFilterDropdown(buttonId, dropdownContentSelector) {
        const button = document.getElementById(buttonId);
        const dropdownContent = document.querySelector(dropdownContentSelector);
        const dropdownContainer = button.closest('.dropdown-container');

        if (!button || !dropdownContent || !dropdownContainer) return;

        button.addEventListener('click', (event) => {
            event.stopPropagation();
            document.querySelectorAll('.dropdown-container.show').forEach(openDropdown => {
                if (openDropdown !== dropdownContainer) {
                    openDropdown.classList.remove('show');
                }
            });
            dropdownContainer.classList.toggle('show');
        });

        dropdownContent.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                dropdownContainer.classList.remove('show');
                currentFileTypeFilter = event.target.dataset.filter;
                updateFileListAndFolders();
            });
        });
    }

    setupFileTypeFilterDropdown('fileTypeFilterBtn', '.toolbar .file-type-filter-dropdown-content');
    setupFileTypeFilterDropdown('fileTypeFilterBtnHeader', '.toolbar-filter-buttons .file-type-filter-dropdown-content');


    // --- Size Filter ---
    function setupSizeFilterDropdown(buttonId, dropdownContentSelector) {
        const button = document.getElementById(buttonId);
        const dropdownContent = document.querySelector(dropdownContentSelector);
        const dropdownContainer = button.closest('.dropdown-container');

        if (!button || !dropdownContent || !dropdownContainer) return;

        button.addEventListener('click', (event) => {
            event.stopPropagation();
            document.querySelectorAll('.dropdown-container.show').forEach(openDropdown => {
                if (openDropdown !== dropdownContainer) {
                    openDropdown.classList.remove('show');
                }
            });
            dropdownContainer.classList.toggle('show');
        });

        dropdownContent.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                dropdownContainer.classList.remove('show');
                currentSizeFilter = event.target.dataset.size;
                updateFileListAndFolders();
            });
        });
    }

    setupSizeFilterDropdown('sizeFilterBtn', '.toolbar .size-filter-dropdown-content');
    setupSizeFilterDropdown('sizeFilterBtnHeader', '.toolbar-filter-buttons .size-filter-dropdown-content');


    // --- Rename File/Folder ---
    function renameFile(id) {
        const item = document.querySelector(`.file-item[data-id="${CSS.escape(id)}"]`);
        if (!item) return;

        const itemType = item.dataset.type;
        const itemName = item.dataset.name;
        const fileType = item.dataset.fileType;

        if (
            itemType === 'file' &&
            restrictedFileTypes.includes(fileType) &&
            currentUserRole !== 'admin' &&
            currentUserRole !== 'moderator'
        ) {
            showNotification('noPermissionRestrictedRename', 'error');
            return;
        }

        document.getElementById('renameItemId').value = id;
        document.getElementById('renameItemActualType').value = itemType;
        document.getElementById('newName').value = itemName;

        const renameItemTypeElement = document.getElementById('renameItemType');
        if (renameItemTypeElement) {
            renameItemTypeElement.textContent = translations[itemType]?.[currentLanguage] ?? itemType;
        }

        openModal(renameModal);
    }

    // --- Download File ---
    function downloadFile(id) {
        const item = document.querySelector(`.file-item[data-id="${CSS.escape(id)}"]`);
        if (!item) return;
        const filePath = item.dataset.path;
        const fileName = item.dataset.name;
        const fileType = item.dataset.fileType;

        if (restrictedFileTypes.includes(fileType) && currentUserRole !== 'admin' && currentUserRole !== 'moderator') {
            showNotification('noPermissionRestrictedDownload', 'error');
            return;
        }

        const link = document.createElement('a');
        link.href = filePath;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- Individual Delete File/Folder ---
    async function deleteFile(id) {
        const item = document.querySelector(`.file-item[data-id="${CSS.escape(id)}"]`);
        if (!item) return;
        const type = item.dataset.type;
        const fileType = item.dataset.fileType;

        if (type === 'file' && restrictedFileTypes.includes(fileType) && currentUserRole !== 'admin' && currentUserRole !== 'moderator') {
            showNotification('noPermissionRestrictedDelete', 'error');
            return;
        }

        const confirmMessage = translations['confirmDelete'][currentLanguage];

        if (confirm(confirmMessage)) {
            try {
                const response = await fetch('delete.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: id, type: type })
                });
                const data = await response.json();
                if (data.success) {
                    showNotification(data.message, 'success');
                    updateFileListAndFolders();
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('errorDeleting', 'error');
            }
        }
    }

    // --- Extract ZIP File ---
    async function extractZipFile(id) {
        const item = document.querySelector(`.file-item[data-id="${CSS.escape(id)}"]`);
        if (!item) return;
        const filePath = item.dataset.path;
        const fileType = item.dataset.fileType;

        if (restrictedFileTypes.includes(fileType) && currentUserRole !== 'admin' && currentUserRole !== 'moderator') {
            showNotification('noPermissionRestrictedExtract', 'error');
            return;
        }

        if (!confirm(translations['confirmExtract'][currentLanguage])) {
            return;
        }

        showNotification('extractingZip', 'info');

        try {
            const response = await fetch('extract.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ file_id: id, file_path: filePath })
            });
            const data = await response.json();
            if (data.success) {
                showNotification(data.message, 'success');
                updateFileListAndFolders();
            } else {
                showNotification('extractionFailed', 'error', data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('errorExtracting', 'error');
        }
    }

    // --- Toggle Star (Pin to Priority) ---
    async function toggleStar(id, type) {
        const item = document.querySelector(`.file-item[data-id="${CSS.escape(id)}"]`);
        if (!item) return;
        const itemName = item.dataset.name;
        const fileType = item.dataset.fileType;

        if (type === 'file' && restrictedFileTypes.includes(fileType) && currentUserRole !== 'admin' && currentUserRole !== 'moderator') {
            showNotification('noPermissionRestrictedPin', 'error');
            return;
        }

        try {
            const response = await fetch('toggle_star.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: id, type: type, name: itemName })
            });
            const data = await response.json();
            if (data.success) {
                showNotification(data.message, 'success');
            } else {
                showNotification('failedToToggleStar', 'error', data.message);
            }
        } catch (error) {
            console.error('Error toggling star:', error);
            showNotification('errorTogglingStar', 'error');
        }
    }

    // --- Form Submissions for Create Folder and Rename ---
    const createFolderForm = document.getElementById('createFolderForm');
    const renameForm = document.getElementById('renameForm');

    createFolderForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        try {
            const response = await fetch(this.action, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                showNotification('folderCreatedSuccess', 'success');
                closeModal(createFolderModal);
                updateFileListAndFolders();
            } else {
                showNotification('failedToCreateFolder', 'error', data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('errorCreatingFolder', 'error');
        }
    });

    renameForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const itemType = formData.get('itemType');
        const itemId = formData.get('itemId');

        if (itemType === 'file') {
            const itemElement = document.querySelector(`.file-item[data-id="${CSS.escape(itemId)}"]`);
            const fileType = itemElement ? itemElement.dataset.fileType : '';
            if (restrictedFileTypes.includes(fileType) && currentUserRole !== 'admin' && currentUserRole !== 'moderator') {
                showNotification('noPermissionRestrictedRename', 'error');
                return;
            }
        }

        try {
            const response = await fetch(this.action, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                showNotification('itemRenamedSuccess', 'success');
                closeModal(renameModal);
                updateFileListAndFolders();
            } else {
                showNotification('failedToRename', 'error', data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('errorRenaming', 'error');
        }
    });

    // --- Search Functionality ---
    function performSearch(query) {
        currentSearchQuery = query.trim();
        updateFileListAndFolders();
    }

    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch(this.value);
        }
    });

    searchInputMobile.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch(this.value);
        }
    });

    // --- File Upload Preview and Handling ---
    fileToUploadInput.addEventListener('change', function() {
        uploadPreviewList.innerHTML = '';
        startUploadBtn.style.display = 'block';
        activeUploads.clear();

        if (this.files.length > 0) {
            Array.from(this.files).forEach((file, index) => {
                const fileId = `upload-item-${index}-${Date.now()}`;
                const fileExt = file.name.split('.').pop().toLowerCase();

                if (restrictedFileTypes.includes(fileExt) && currentUserRole !== 'admin' && currentUserRole !== 'moderator') {
                    showNotification('fileRestrictedUpload', 'error', `'${file.name}'`);
                    const uploadItemHtml = `
                        <div class="upload-item" id="${fileId}">
                            <i class="fas fa-ban file-icon file-color-error"></i>
                            <div class="upload-item-info">
                                <strong>${file.name}</strong>
                                <div class="upload-progress-container">
                                    <div class="upload-progress-bar" style="width: 100%; background-color: var(--error-color);"></div>
                                </div>
                            </div>
                            <span class="upload-status-icon error"><i class="fas fa-times-circle"></i></span>
                        </div>
                    `;
                    uploadPreviewList.insertAdjacentHTML('beforeend', uploadItemHtml);
                    return;
                }

                const iconClass = getFileIconClass(file.name);
                const colorClass = getFileColorClass(file.name);
                
                const uploadItemHtml = `
                    <div class="upload-item" id="${fileId}">
                        <i class="fas ${iconClass} file-icon ${colorClass}"></i>
                        <div class="upload-item-info">
                            <strong>${file.name}</strong>
                            <div class="upload-progress-container">
                                <div class="upload-progress-bar" style="width: 0%;"></div>
                            </div>
                        </div>
                        <span class="upload-status-icon processing"><i class="fas fa-spinner fa-spin"></i></span>
                        <button class="upload-action-button cancel-upload-btn" data-file-id="${fileId}"><i class="fas fa-times"></i></button>
                    </div>
                `;
                uploadPreviewList.insertAdjacentHTML('beforeend', uploadItemHtml);

                const fileElement = document.getElementById(fileId);
                activeUploads.set(fileId, { file: file, element: fileElement, controller: null });
            });
        } else {
            startUploadBtn.style.display = 'none';
        }
    });

    document.getElementById('startUploadBtn').addEventListener('click', function(e) {
        e.preventDefault();
        if (fileToUploadInput.files.length === 0) {
            showNotification('noFilesToUpload', 'error');
            return;
        }
        if (isStorageFull) { // Use isStorageFull from phpVars
            showNotification('storageFullCannotUpload', 'error');
            return;
        }

        closeModal(uploadFileModal);
        openModal(uploadPreviewModal);

        let allUploadsCompleted = 0;
        const filesToUpload = Array.from(activeUploads.values()).filter(item => {
            const fileExt = item.file.name.split('.').pop().toLowerCase();
            return !(restrictedFileTypes.includes(fileExt) && currentUserRole !== 'admin' && currentUserRole !== 'moderator');
        });
        const totalUploads = filesToUpload.length;

        if (totalUploads === 0) {
            showNotification('noFilesEligible', 'info');
            setTimeout(() => closeModal(uploadPreviewModal), 1000);
            return;
        }

        filesToUpload.forEach((item) => {
            const controller = new AbortController();
            item.controller = controller;
            uploadFile(item.file, item.element.id, controller.signal).then(() => {
                allUploadsCompleted++;
                if (allUploadsCompleted === totalUploads) {
                    setTimeout(() => {
                        updateFileListAndFolders();
                        closeModal(uploadPreviewModal);
                    }, 1000);
                }
            });
        });
    });

    async function uploadFile(file, fileId, signal) {
        const currentFolderIdInput = document.querySelector('input[name="current_folder_id"]');
        const currentFolderPathInput = document.querySelector('input[name="current_folder_path"]');

        const formData = new FormData();
        formData.append('fileToUpload[]', file);
        formData.append('current_folder_id', currentFolderIdInput ? currentFolderIdInput.value : '');
        formData.append('current_folder_path', currentFolderPathInput ? currentFolderPathInput.value : '');

        const uploadItemElement = document.getElementById(fileId);
        const progressBar = uploadItemElement.querySelector('.upload-progress-bar');
        const statusIcon = uploadItemElement.querySelector('.upload-status-icon');
        const cancelButton = uploadItemElement.querySelector('.cancel-upload-btn');

        statusIcon.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        statusIcon.classList.remove('success', 'error', 'cancelled');
        statusIcon.classList.add('processing');
        cancelButton.style.display = 'block';

        try {
            const response = await fetch('upload.php', {
                method: 'POST',
                body: formData,
                signal: signal,
            });

            if (!response.ok) {
                throw new Error(`Server responded with status ${response.status}`);
            }

            const data = await response.json();

            if (data.success) {
                progressBar.style.width = '100%';
                progressBar.style.backgroundColor = 'var(--success-color)';
                statusIcon.innerHTML = '<i class="fas fa-check"></i>';
                statusIcon.classList.remove('processing', 'error', 'cancelled');
                statusIcon.classList.add('success');
                uploadItemElement.classList.add('complete');
                showNotification('fileUploadedSuccess', 'success', `'${file.name}'`);
            } else {
                throw new Error(data.message || 'Unknown error during upload.');
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                progressBar.style.width = '100%';
                progressBar.style.backgroundColor = 'var(--warning-color)';
                statusIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
                statusIcon.classList.remove('processing', 'error');
                statusIcon.classList.add('cancelled');
                showNotification('uploadCancelled', 'error', `'${file.name}'`);
            } else {
                progressBar.style.width = '100%';
                progressBar.style.backgroundColor = 'var(--error-color)';
                statusIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
                statusIcon.classList.remove('processing', 'success', 'cancelled');
                statusIcon.classList.add('error');
                showNotification('failedToUpload', 'error', `'${file.name}': ${error.message}`);
            }
            uploadItemElement.classList.add('complete');
        } finally {
            cancelButton.style.display = 'none';
            activeUploads.delete(fileId);
        }
    }

    uploadPreviewList.addEventListener('click', function(event) {
        if (event.target.closest('.cancel-upload-btn')) {
            const button = event.target.closest('.cancel-upload-btn');
            const fileId = button.dataset.fileId;
            const uploadItem = activeUploads.get(fileId);

            if (uploadItem && uploadItem.controller) {
                uploadItem.controller.abort();
                activeUploads.delete(fileId);
                const uploadItemElement = document.getElementById(fileId);
                const progressBar = uploadItemElement.querySelector('.upload-progress-bar');
                const statusIcon = uploadItemElement.querySelector('.upload-status-icon');

                progressBar.style.width = '100%';
                progressBar.style.backgroundColor = 'var(--warning-color)';
                statusIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
                statusIcon.classList.remove('processing', 'success', 'error');
                statusIcon.classList.add('cancelled');
                button.style.display = 'none';
                uploadItemElement.classList.add('complete');
                showNotification('uploadManuallyCancelled', 'error', `'${uploadItem.file.name}'`);

                if (activeUploads.size === 0) {
                    setTimeout(() => {
                        updateFileListAndFolders();
                        closeModal(uploadPreviewModal);
                    }, 1000);
                }
            }
        }
    });

    // --- Share Link Functionality ---
    async function shareFileLink(id) {
        const item = document.querySelector(`.file-item[data-id="${CSS.escape(id)}"]`);
        if (!item) return;
        const itemType = item.dataset.type;
        const fileType = item.dataset.fileType;

        if (itemType !== 'file') {
            showNotification('onlyFilesCanBeShared', 'error');
            return;
        }

        if (restrictedFileTypes.includes(fileType) && currentUserRole !== 'admin' && currentUserRole !== 'moderator') {
            showNotification('noPermissionRestrictedShare', 'error');
            return;
        }

        showNotification('generatingShareLink', 'info');

        try {
            const response = await fetch('generate_share_link.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `file_id=${id}`
            });

            const data = await response.json();

            if (data.success) {
                shortLinkOutput.value = data.shortlink;
                openModal(shareLinkModal);
                showNotification('shareLinkGenerated', 'success');
            } else {
                showNotification('failedToGenerateShareLink', 'error', data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('errorGeneratingShareLink', 'error');
        }
    }

    copyShortLinkBtn.addEventListener('click', () => {
        shortLinkOutput.select();
        shortLinkOutput.setSelectionRange(0, 99999);
        document.execCommand('copy');
        showNotification('linkCopied', 'success');
    });

    /*** Context menu element ***/
    function showContextMenuFor(fileEl, x, y) {
        if (!fileEl) return;
        contextMenu.dataset.targetId = fileEl.dataset.id;
        contextMenu.dataset.targetType = fileEl.dataset.type;
        contextMenu.dataset.targetName = fileEl.dataset.name;
        contextMenu.dataset.targetFileType = fileEl.dataset.fileType || '';

        const itemType = fileEl.dataset.type;
        const fileType = fileEl.dataset.fileType;
        const isRestricted = restrictedFileTypes.includes(fileType);
        const canAccessRestricted = (currentUserRole === 'admin' || currentUserRole === 'moderator');

        contextRename.classList.remove('hidden');
        contextDownload.classList.remove('hidden');
        contextShare.classList.remove('hidden');
        contextExtract.classList.remove('hidden');
        contextToggleStar.classList.remove('hidden');
        contextDelete.classList.remove('hidden');

        if (itemType === 'folder') {
            contextDownload.classList.add('hidden');
            contextShare.classList.add('hidden');
            contextExtract.classList.add('hidden');
        } else if (itemType === 'file') {
            if (fileType !== 'zip') {
                contextExtract.classList.add('hidden');
            }
            if (isRestricted && !canAccessRestricted) {
                contextRename.classList.add('hidden');
                contextDownload.classList.add('hidden');
                contextShare.classList.add('hidden');
                contextExtract.classList.add('hidden');
                contextToggleStar.classList.add('hidden');
                contextDelete.classList.add('hidden');
            }
        }

        const rect = contextMenu.getBoundingClientRect();
        const menuWidth = rect.width || 200;
        const menuHeight = rect.height || 220;

        let finalLeft = x;
        let finalTop = y;

        if (x + menuWidth > window.innerWidth) {
            finalLeft = window.innerWidth - menuWidth - 10;
        }

        if (y + menuHeight > window.innerHeight) {
            finalTop = window.innerHeight - menuHeight - 10;
        }

        contextMenu.style.left = finalLeft + 'px';
        contextMenu.style.top = finalTop + 'px';
        contextMenu.classList.add('visible');
        contextMenu.hidden = false;
        suppressOpenClickTemporarily();
    }

    function hideContextMenu(){
        contextMenu.classList.remove('visible');
        contextMenu.hidden = true;
        contextMenu.dataset.targetId = '';
        contextMenu.dataset.targetType = '';
        contextMenu.dataset.targetName = '';
        contextMenu.dataset.targetFileType = '';
    }

    let _suppressOpenUntil = 0;
    function suppressOpenClickTemporarily(ms=350){
        _suppressOpenUntil = Date.now() + ms;
    }

    function openFileById(id){
        if (Date.now() < _suppressOpenUntil) { return; }
        const fileItem = document.querySelector(`.file-item[data-id="${CSS.escape(id)}"]`);
        if (fileItem) {
            const itemType = fileItem.dataset.type;
            const fileType = fileItem.dataset.fileType;
            const isRestricted = restrictedFileTypes.includes(fileType);
            const canAccessRestricted = (currentUserRole === 'admin' || currentUserRole === 'moderator');

            if (itemType === 'file' && isRestricted && !canAccessRestricted) {
                showNotification('noPermissionRestrictedOpen', 'error');
                return;
            }

            if (itemType === 'file') {
                window.location.href = `view.php?file_id=${id}`;
            } else if (itemType === 'folder') {
                window.location.href = `index.php?folder=${id}`;
            }
        }
    }

    document.addEventListener('click', function(e){
        const moreBtn = e.target.closest('.item-more');
        if (moreBtn) {
            const file = closestFileItem(moreBtn);
            const r = moreBtn.getBoundingClientRect();
            showContextMenuFor(file, r.right - 5, r.bottom + 5);
            e.stopPropagation();
            return;
        }

        const file = closestFileItem(e.target);
        if (file && !e.target.classList.contains('file-checkbox')) {
            openFileById(file.dataset.id);
        } else {
            hideContextMenu();
        }
    });

    document.addEventListener('contextmenu', function(e){
        if (! (document.body.classList.contains('desktop') || document.body.classList.contains('tablet-landscape')) ) return;
        const file = closestFileItem(e.target);
        if (file) {
            e.preventDefault();
            showContextMenuFor(file, e.clientX, e.clientY);
        } else {
            hideContextMenu();
        }
    });

    document.addEventListener('pointerdown', function(e){
        if (! (document.body.classList.contains('mobile') ||
            document.body.classList.contains('tablet-portrait') ||
            document.body.classList.contains('device-ipad')) ) return;

        const file = closestFileItem(e.target);
        if (!file) return;
        if (e.target.classList.contains('file-checkbox')) return;

        if (e.pointerType !== 'touch') return;

        const startX = e.clientX, startY = e.clientY;
        lpStart = file;
        lpTimer = setTimeout(()=> {
            showContextMenuFor(file, startX, startY);
            lpTimer = null;
            suppressOpenClickTemporarily();
        }, longPressDuration);

        function onMove(ev){
            if (Math.hypot(ev.clientX - startX, ev.clientY - startY) > longPressMoveThreshold) {
                clearLongPress();
            }
        }
        function clearLongPress(){
            if (lpTimer) clearTimeout(lpTimer);
            lpTimer = null;
            lpStart = null;
            file.removeEventListener('pointermove', onMove);
            file.removeEventListener('pointerup', clearLongPress);
            file.removeEventListener('pointercancel', clearLongPress);
        }
        file.addEventListener('pointermove', onMove);
        file.addEventListener('pointerup', clearLongPress);
        file.addEventListener('pointercancel', clearLongPress);
    });

    document.addEventListener('keydown', function(e){
        const focused = document.activeElement && document.activeElement.closest && document.activeElement.closest('.file-item');
        if (!focused) return;
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            if (!document.activeElement.classList.contains('file-checkbox')) {
                openFileById(focused.dataset.id);
            }
        } else if (e.key === 'ContextMenu' || (e.shiftKey && e.key === 'F10')) {
            e.preventDefault();
            const rect = focused.getBoundingClientRect();
            showContextMenuFor(focused, rect.left + 8, rect.bottom + 8);
        }
    });

    contextMenu.addEventListener('click', function(e){
        const li = e.target.closest('[data-action]');
        if (!li) return;
        const action = li.dataset.action;
        const targetId = contextMenu.dataset.targetId;
        const targetType = contextMenu.dataset.targetType;
        const targetName = contextMenu.dataset.targetName;
        const targetFileType = contextMenu.dataset.targetFileType;

        const isRestricted = restrictedFileTypes.includes(targetFileType);
        const canAccessRestricted = (currentUserRole === 'admin' || currentUserRole === 'moderator');

        if (isRestricted && !canAccessRestricted && (action === 'rename' || action === 'download' || action === 'share' || action === 'extract' || action === 'toggle-star' || action === 'delete')) {
            showNotification('noPermissionRestrictedAction', 'error');
            hideContextMenu();
            return;
        }

        if (action === 'toggle-star') {
            toggleStar(targetId, targetType, targetName);
        } else {
            handleMenuAction(action, targetId);
        }
        hideContextMenu();
    });

    document.addEventListener('click', function(e){
        if (!e.target.closest('#context-menu') && !e.target.closest('.item-more')) {
            hideContextMenu();
        }
    });
    window.addEventListener('blur', hideContextMenu);

    function handleMenuAction(action, id){
        switch(action){
            case 'rename': renameFile(id); break;
            case 'download': downloadFile(id); break;
            case 'share': shareFileLink(id); break;
            case 'extract': extractZipFile(id); break;
            case 'delete': deleteFile(id); break;
            default: console.log('Unknown action', action);
        }
    }

    // --- AJAX Content Update Function ---
    async function updateFileListAndFolders() {
        const params = new URLSearchParams();
        if (currentFolderId !== null) {
            params.set('folder', currentFolderId);
        }
        if (currentSearchQuery) {
            params.set('search', currentSearchQuery);
        }
        if (currentSizeFilter && currentSizeFilter !== 'none') {
            params.set('size', currentSizeFilter);
        }
        if (currentFileTypeFilter && currentFileTypeFilter !== 'all') {
            params.set('file_type', currentFileTypeFilter);
        }

        const url = `index.php?${params.toString()}&ajax=1`;

        try {
            const response = await fetch(url);
            const html = await response.text();

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            const newFileListView = tempDiv.querySelector('#fileListView table tbody').innerHTML;
            const newFileGridView = tempDiv.querySelector('#fileGridView .file-grid').innerHTML;
            const newBreadcrumbs = tempDiv.querySelector('.breadcrumbs').innerHTML;
            const newStorageInfo = tempDiv.querySelector('.storage-info').innerHTML;

            document.querySelector('#fileListView table tbody').innerHTML = newFileListView;
            document.querySelector('#fileGridView .file-grid').innerHTML = newFileGridView;
            document.querySelector('.breadcrumbs').innerHTML = newBreadcrumbs;
            document.querySelector('.storage-info').innerHTML = newStorageInfo;

            updateSelectAllCheckboxListener();

            history.pushState(null, '', `index.php?${params.toString()}`);

            applyTranslation(currentLanguage);

        } catch (error) {
            console.error('Error updating file list:', error);
        }
    }

    // Event listener for breadcrumbs (folder navigation)
    document.querySelector('.breadcrumbs').addEventListener('click', function(event) {
        if (event.target.tagName === 'A') {
            event.preventDefault();
            const href = event.target.getAttribute('href');
            const url = new URL(href, window.location.origin);
            const folderId = url.searchParams.get('folder');
            currentFolderId = folderId ? parseInt(folderId) : null;
            currentSearchQuery = '';
            searchInput.value = '';
            searchInputMobile.value = '';
            updateFileListAndFolders();
        }
    });

    // --- Mobile Sidebar Toggle ---
    sidebarToggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('show-mobile-sidebar');
        mobileOverlay.classList.toggle('show');
    });

    // --- Sidebar Menu Navigation with Fly Out Animation ---
    const sidebarMenuItems = document.querySelectorAll('.sidebar-menu a'); // Re-declare for scope
    sidebarMenuItems.forEach(item => {
        item.addEventListener('click', function(event) {
            if (this.getAttribute('href') && !this.classList.contains('active')) {
                event.preventDefault();
                const targetUrl = this.getAttribute('href');

                mainContent.classList.add('fly-out');

                mainContent.addEventListener('animationend', function handler() {
                    mainContent.removeEventListener('animationend', handler);
                    window.location.href = targetUrl;
                });
            }
        });
    });

    // Set active class for current page in sidebar
    const currentPage = window.location.pathname.split('/').pop();
    sidebarMenuItems.forEach(item => {
        item.classList.remove('active');
        const itemHref = item.getAttribute('href');
        if (itemHref === currentPage || (currentPage === 'index.php' && itemHref === 'index.php')) {
            item.classList.add('active');
        }
    });

    // Initial call to attach listeners
    updateSelectAllCheckboxListener();

    // Apply initial translation on page load
    applyTranslation(currentLanguage);
});
